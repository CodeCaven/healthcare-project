<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>MonashTechTitans</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    
    <!-- Google Fonts Roboto -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap"/>
    <!-- MDB -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.2.0/mdb.min.css" rel="stylesheet" />
    <link rel="shortcut icon" type="image/jpg" href="/images/favicon.jpg"/> 
    <!-- Bootstrap Datatables-->
	<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.css" />
    

    <!--<script src="https://d3js.org/d3.v6.js"></script> D3 v6-->
    <script src="https://d3js.org/d3.v4.min.js"></script> <!--D3 v4 for events-->
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <script src="./javascripts/control.js"></script>
    <script type="text/javascript">

        let met_table = JSON.parse(<%-JSON.stringify(ejs_met)%>);


        // global units
        let vhu;
        let vwu;

        // global vars and storage
        let activities = {};
        let display_activity = "Sitting at a desk";
        let metric = "KGS";
        let weight = 75;
        let minutes = 30;
        let metric_smalls = {"KGS": " Between 30-200 kgs. ", "POUNDS": " Between 66-440 pounds. "}
        
        // DOM loaded callback
		document.addEventListener('DOMContentLoaded', function() {
            
           // log data
           console.log("MET calories page");

           // global units
           vhu = window.innerHeight/100;
           vwu = window.innerWidth/100;
           console.log("height and width window units");
           console.log(vhu);
           console.log(vwu);
           console.log(met_table);

           // create MET table
           var met_table_body = document.getElementById('table-met-body');
           for(let i in met_table){
            // new row
             var table_row = document.createElement("tr");

             // loop for activities and icons
             for(let j in met_table[i]){
                var table_td_1 = document.createElement("td");
                table_td_1.innerHTML = met_table[i][j]['activity'];
                table_td_1.id = met_table[i][j]['activity'];
                activities[met_table[i][j]['activity']] = met_table[i][j]['metscore'];

                // set initial
                if(met_table[i][j]['activity'] == display_activity){
                    table_td_1.style.backgroundColor = "var(--mdb-dark)";
                    table_td_1.style.color = "white";
                }

                var new_icon = document.createElement("i");
                new_icon.className = met_table[i][j]['icon'] + " icon";

                table_td_1.append(document.createElement("br"));
                table_td_1.append(new_icon);
                table_row.append(table_td_1);
                
             }
            met_table_body.append(table_row);
            
           }

          // events
          document.getElementById('table-met').addEventListener("click", tableClick);
          document.getElementById('minutes').addEventListener("input", handleMinutes);
          document.getElementById('weight').addEventListener("input", handleWeight);
          document.getElementById('metrics').addEventListener("input", handleMetric);

          // set calories
          document.getElementById('calories').innerHTML = calculate();

          // set radio weight 
          let metric_radios = document.getElementsByName("metricRadio");
           for(let i=0; i<metric_radios.length;i++){
                if(metric_radios[i].value == metric){
                    metric_radios[i].checked = true;
                }
           }

        }, false);

        // calories calculator
        function calculate(){
            /* THE MATHS */
            // METs x 3.5 x (your body weight in kilograms) / 200 = calories burned per minute
            // 1kg = 2.204623 pounds
            // 1 pound = 0.4535924 kgs
            // range = [6, 7245]

            if(metric == "KGS"){
                return parseInt(((activities[display_activity] * 3.5 * weight)/200)*minutes);
            }

            if(metric == "POUNDS"){
                return parseInt(((activities[display_activity] * 3.5 * weight * 0.4535924)/200)*minutes);
            }

        }

        // event handlers
        function tableClick(event){
            // unhighlight all
           let cells = document.getElementsByTagName("td");
           for(let cell of cells){
                cell.style.backgroundColor = "var(--mdb-table-bg)";
                cell.style.color = "black";
           }

           // highlight cell
           if(event.target.tagName == "TD"){
                event.target.style.backgroundColor = "var(--mdb-dark)";
                event.target.style.color = "white";
                display_activity = event.target.id;
            }

            if(event.target.tagName == "I"){
                event.target.parentNode.style.backgroundColor = "var(--mdb-dark)";
                event.target.parentNode.style.color = "white";
                display_activity = event.target.parentNode.id;
            }
            
            // set calories
            document.getElementById('calories').innerHTML = calculate();
        }

        function handleMinutes(event){
            
            if( event.target.value > 9 &&  event.target.value < 181){
                // set minutes
                minutes = event.target.value;
                // set calories
                document.getElementById('calories').innerHTML = calculate();
            }
        }

        function handleWeight(event){
            if(metric == "KGS"){
                if( event.target.value > 29 &&  event.target.value < 201){
                    // set minutes
                    weight = event.target.value;
                    // set calories
                    document.getElementById('calories').innerHTML = calculate();
                }
            }

            if(metric == "POUNDS"){
                if( event.target.value > 65 &&  event.target.value < 441){
                    // set minutes
                    weight = event.target.value;
                    // set calories
                    document.getElementById('calories').innerHTML = calculate();
                }
            }
        }

        function handleMetric(event){
            // set metric
            metric = event.target.value;

            // update display and range
            document.getElementById('weightSmall').innerHTML = metric_smalls[metric];

            // update min max
            if(metric == "KGS"){
                document.getElementById('weight').setAttribute("min", "30");
                document.getElementById('weight').setAttribute("max", "200");
            }

            if(metric == "POUNDS"){
                document.getElementById('weight').setAttribute("min", "66");
                document.getElementById('weight').setAttribute("max", "440");
            }
        }
        
    </script>
</head>